<?php

require_once(__DIR__ . '/header.phtml');
?>
<?php
date_default_timezone_set('Europe/Berlin');
$room = is_array($room ?? null) ? $room : []; ?>
    <div class="rooms-wrapper">
        <div class="rooms room-detail">
            <div class="room-titlebar">
                <h1>Raum: <?= htmlspecialchars($room['name']) ?></h1>
                <a href="/rooms" class="back-link" aria-label="Zurück zu den Räumen">← Zurück zu den Räumen</a>
            </div>
            <?php
            if (!empty($room['description'])): ?>
                <p class="room-desc"><?= htmlspecialchars($room['description']) ?></p>
            <?php
            endif; ?>

            <?php
            $items = $task ?? ($room['task'] ?? []);
            ?>

            <h2>Aktuelle Task</h2>
            <?php
            if (!empty($items)): ?>
                <ul class="task-list">
                    <?php
                    foreach ($items as $t): ?>
                        <li class="task-card">
                            <div class="task-header">
                                <h3><?= htmlspecialchars($t['title'] ?? '') ?></h3>
                                <form action="/task-delete" method="post" class="delete-form">
                                    <input type="hidden" name="task_id" value="<?= $t['id'] ?>">
                                    <input type="hidden" name="room_id"
                                           value="<?= isset($room['id']) ? (int)$room['id'] : '' ?>">
                                    <button type="submit" class="delete-btn">✕</button>
                                </form>
                            </div>

                            <div class="task-body">
                                <p><strong>Endet in:</strong>
                                    <?php
                                    if (!empty($t['due_at'])) {
                                        $now = new DateTime();
                                        $dt = $t['due_at'] instanceof DateTime ? $t['due_at'] : new DateTime(
                                                $t['due_at']
                                        );
                                        if ($dt > $now) {
                                            $difference = $now->diff($dt);
                                            echo $difference->format('%a Tage, %h Std, %i Min');
                                        } else {
                                            echo 'abgelaufen';
                                        }
                                        echo ' (am ' . htmlspecialchars($dt->format('d.m.Y H:i')) . ')';
                                    }
                                    ?>
                                </p>
                                <p><?= nl2br(htmlspecialchars($t['notes'] ?? '')) ?></p>
                            </div>
                        </li>
                    <?php
                    endforeach; ?>
                </ul>
            <?php
            else: ?>
                <p>Keine Einträge vorhanden.</p>
            <?php
            endif; ?>

            <h2>Neue Task hinzufügen</h2>
            <form action="/task-submit" method="post">
                <input type="hidden" name="room_id" value="<?= isset($room['id']) ? (int)$room['id'] : '' ?>">

                <div>
                    <label for="task_title">Titel</label>
                    <input type="text" id="task_title" name="task_title" >
                </div>

                <div>
                    <label for="task_notes">Notizen</label>
                    <textarea id="task_notes" name="task_notes" rows="4"></textarea>
                </div>
                <div>
                    <label for="task_due_at">Fällig am</label>
                    <input type="datetime-local" id="task_due_at" name="task_due_at"
                           value="<?= date('Y-m-d\\TH:i', time() + 300) ?>" required>
                </div>

                <div>
                    <label for="task_priority">Priorität</label>
                    <select id="task_priority" name="task_priority">
                        <option value="low">Niedrig</option>
                        <option value="medium">Mittel</option>
                        <option value="high">Hoch</option>
                    </select>
                </div>

                <div>
                    <label for="task_repeat">Wiederholung</label>
                    <select id="task_repeat" name="task_repeat">
                        <option value="false">Nein</option>
                        <option value="true">Ja</option>
                    </select>
                </div>

                <div>
                    <label for="task_repeat_rule">Wiederholungsregel</label>
                    <select id="task_repeat_rule" name="task_repeat_rule">
                        <option value="false">------</option>
                        <option value="60_minutes">1 Stunde</option>
                        <option value="120_minutes">2 Stunden</option>
                        <option value="1_day">1 Tag</option>
                        <option value="2_days">2 Tage</option>
                        <option value="7_days">7 Tage</option>
                        <option value="14_days">14 Tage</option>
                        <option value="28_days">28 Tage</option>
                    </select>
                </div>

                <input type="hidden" name="task_created_at" value="<?= date('Y-m-d H:i:s') ?>">

                <button type="submit">Task anlegen</button>

            </form>
        </div>
    </div>

<?php
if (!empty($errors)): ?>
    <div class="error-messages">
        <?php
        foreach ($errors as $field => $messages): ?>
            <h3><?= htmlspecialchars(ucfirst($field)) ?></h3>
            <ul>
                <?php
                foreach ($messages as $message): ?>
                    <li><?= htmlspecialchars($message) ?></li>
                <?php
                endforeach; ?>
            </ul>
        <?php
        endforeach; ?>
    </div>
<?php
endif; ?>

<?php
require_once(__DIR__ . '/footer.phtml');
?>